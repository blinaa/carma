# baseline/patches

# Приёмы разработки

После разворачивания дампа БД на локальной машине удобнее использовать шаблоны (чтобы не пересоздавать индексы):

    psql carma -c 'CREATE DATABASE carma_bak WITH TEMPLATE carma;'

Теперь, если база `carma` будет испорчена после плохо описанной миграции, её можно будет развернуть из шаблона `carma_bak`:

    dropdb carma
    psql carma_bak -c 'CREATE DATABASE carma WITH TEMPLATE carma_bak;'

# Idents

* как они делаются
* как использовать их на сервере и клиенте

## Использование

### На клиенте

Заданные в методе `idents` для модели `Model` константы доступны по строковым названиями через `global.idents("Model")`.

# Управление миграциями с помощью db.sh

```
./db.sh update
```

* проверка коллизий
* подключение пропущенных миграций
* версии baseline-данных, используемые в патчах

## Приёмы слияния веток с миграциями

## buildbot

Бот на тестовом сервере помимо пересборки исходников каждую ночь выполняет следующие операции:

1. База `carma` на тестовом сервере уничтожается.
2. Последний доступный бэкап продукционной базы данных разворачивается в базу `carma`. Ссылка на этот бэкап устанавливается в `~carma/prod-dump.sql.gz`.
3. Накладываются все миграции с помощью `db.sh update`. Пропущенные миграции также накладываются (на все вопросы даётся ответ `1`).
4. После успешного наложения миграций полученное состояние базы дампится в `~carma/latest-dump.sql.gz`. Оттуда его можно скачать для удобства разработки.
4. Если при накладывании миграций произошла ошибка, то бот ищет файл `~carma/latest-dump.sql.gz`. Если таковой имеется, то он используется в качестве дампа для разворачивания базы. Расчёт на то, что последний удачный дамп позволит иметь хотя бы частично работоспособную систему на тесте. Также сохранение последнего удачного дампа позволит разработчику проще опробовать исправление миграций на тесте.