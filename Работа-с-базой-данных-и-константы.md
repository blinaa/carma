# baseline/patches

# Приёмы разработки

Дамп базы можно взять с тестового сервера (см. [buildbot](https://github.com/f-me/carma/wiki/%D0%A0%D0%B0%D0%B1%D0%BE%D1%82%D0%B0-%D1%81-%D0%B1%D0%B0%D0%B7%D0%BE%D0%B9-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85-%D0%B8-%D0%BA%D0%BE%D0%BD%D1%81%D1%82%D0%B0%D0%BD%D1%82%D1%8B#buildbot))

После разворачивания дампа БД на локальной машине удобнее использовать шаблоны (чтобы не пересоздавать индексы):

    psql carma -c 'CREATE DATABASE carma_bak WITH TEMPLATE carma;'

Теперь, если база `carma` будет испорчена после плохо описанной миграции, её можно будет развернуть из шаблона `carma_bak`:

    dropdb carma
    psql carma_bak -c 'CREATE DATABASE carma WITH TEMPLATE carma_bak;'

# Idents

В случае, когда логика приложения зависит от конкретного значения поля в базе данных, например, марки автомобиля (допустим элемента с идентификатором 5 в справочнике `CarMake`), во избежание появления магических констант в коде необходимо сделать следующее:

1. Описать миграцию для БД, которая добавляет данное значение в базу (если его там ещё нет), а также обновить код справочника в baseline.
2. Записать это значение в модуль из пакета [carma-models](/f-me/carma-models) с описанием соответствующей модели данных. Константы для модели `M` имеют тип `IdentI M`.

Создать константу можно двумя способами (в примерах описано создание констант для модели `CarMake`):

1. Явно описать отдельное значение:
   
   ```haskell
   peugeot :: IdentI CarMake
   peugeot = 12
   ```
2. Использовать Template Haskell-конструкцию `mkIdents`:
   
   ```haskell
   {-# LANGUAGE TemplateHaskell #-}
   import Data.Model.TH
   …
   mkIdents [t|CarMake|]
    [ ("vw", 1)
    , ("sy", 48)
    ]
   ```
Данный способ отличается от обычного тем, что помимо создания значений вида `vw = 1 :: IdentI CarMake`, он также задаёт отображение `idents :: HashMap.HashMap String (IdentI CarMake)`, которое позволяет из строки с названием константы получить её числовое значение. Эта возможность используется при проверке прав на экраны (т.к. screens.json использует текстовые названия ролей) и на клиенте.

Задание констант в модуле предполагает либо отсутствие списка экспортируемых идентификаторов в заголовке модуля:
```haskell
module Carma.Model.CarMake

where
…
```
либо явно перечисление всех заданных констант:
```haskell
module Carma.Model.CarMake (…, peugeot, citroen)

where
…
```

## Использование

### В серверном коде

После импорта модуля с заданными константами они используются как обычные значения:

```haskell
import qualified Carma.Model.CarMake as CarMake
…
    if cm == CarMake.peugeot
    …
```

### На клиенте

Заданные в методе `idents` (т.е. если для описания констант использовалась конструкция `mkIdents`) для модели `Model` константы доступны по строковым названиями через объект `global.idents("Model")`.

# Управление миграциями с помощью db.sh

```
./db.sh update
```

* проверка коллизий
* подключение пропущенных миграций
* версии baseline-данных, используемые в патчах

## Приёмы слияния веток с миграциями

## buildbot

Бот на тестовом сервере помимо пересборки исходников каждую ночь выполняет следующие операции:

1. База `carma` на тестовом сервере уничтожается.
2. Последний доступный бэкап продукционной базы данных разворачивается в базу `carma`. Ссылка на этот бэкап устанавливается в `~carma/prod-dump.sql.gz`.
3. Накладываются все миграции с помощью `db.sh update`. Пропущенные миграции также накладываются (на все вопросы даётся ответ `1`).
4. После успешного наложения миграций полученное состояние базы дампится в `~carma/latest-dump.sql.gz`. Оттуда его можно скачать для удобства разработки.
4. Если при накладывании миграций произошла ошибка, то бот ищет файл `~carma/latest-dump.sql.gz`. Если таковой имеется, то он используется в качестве дампа для разворачивания базы. Расчёт на то, что последний удачный дамп позволит иметь хотя бы частично работоспособную систему на тесте. Также сохранение последнего удачного дампа позволит разработчику проще опробовать исправление миграций на тесте.